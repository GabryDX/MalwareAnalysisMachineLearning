import os
import progress_bar


folder_path = 'D:\\Users\\Gabriele\\Desktop\\Machine Learning\\Homework 1\\drebin\\feature_vectors\\'
# folder_path = 'D:\\Users\\Gabriele\\Desktop\\Machine Learning\\Homework 1\\drebin\\reduced\\'
csv_path = 'sha256_family.csv'


malware_map = dict()
folder_list = list()
chosen_features = {'permission', 'api_call', 'url', 'intent', 'activity', 'service', 'service_receiver', 'feature'}


def load_malware_info():
	"""Returns a dictionary with the hash filename as key and family of a malware as value"""
	with open(csv_path, 'r') as f:
		raw_data = f.read()
		f.close()
	raw_data = raw_data.strip()
	data = raw_data.split('\n')
	data = data[1:]
	global malware_map
	malware_map = dict()
	for row in data:
		d = row.split(',')
		malware_map.update({d[0]: d[1]})
	return malware_map


def folder_to_list():
	"""Returns a list with all the filenames in a folder"""
	global folder_list
	folder_list = os.listdir(folder_path)
	return folder_list


def analyze_file(filename, family_dictionary):
	"""Gets all the features of a specific file and puts them in the family dictionary"""
	with open(folder_path + filename, 'r') as f:
		raw_data = f.read()
		f.close()
	raw_data = raw_data.strip()
	data = raw_data.split('\n')
	dic = family_dictionary
	global chosen_features
	for d in data:
		if d:
			d = d.strip()
			infos = d.split('::')
			tipo = infos[0]
			valore = infos[1]
			if tipo in chosen_features:
				if tipo in dic.keys():
					valori = dic.get(tipo)
					if valore in valori.keys():
						v = valori.get(valore)
						v += 1
						valori.update({valore: v})
					else:
						valori.update({valore: 1})
					dic.update({tipo: valori})
				else:
					dic.update({tipo: {valore: 1}})
	return dic


def database_train(train_data):
	"""Organizes the training set getting all the data"""
	print('Creating Dataset from Training Data - Start')
	global malware_map
	db = {}
	max_bar = len(train_data)
	incremento = 0
	for filename in train_data:
		if filename in malware_map.keys():
			fam = malware_map.get(filename)
		else:
			fam = 'Safe'
		if fam in db.keys():
			dic = analyze_file(filename, db.get(fam))
		else:
			dic = analyze_file(filename, {})
		db.update({fam: dic})
		incremento += 1
		progress_bar.update(max_bar, incremento)
	print('Creating Dataset from Training Data - End')
	return db


def count_files_bernoulli(train_data, malware_files):
	"""Total number of files in families safe and malware"""
	n_malware = 0
	for mf in malware_files:
		if mf in train_data:
			n_malware += 1
	n_safe = len(train_data) - n_malware
	return n_safe, n_malware


def count_files_multinomial(safe, malware):
	"""Total number of occurrences in families safe and malware"""
	n_safe = 0
	for s in safe.values():
		n_safe += s
	n_malware = 0
	for m in malware.values():
		n_malware += m
	return n_safe, n_malware


def create_dictionary_file(filename):
	"""All the features of a specific file"""
	file_analysis = analyze_file(filename, {})
	db_prefix = {}
	for prefix in file_analysis.keys():
		values = file_analysis.get(prefix)
		for value in values:
			if value in db_prefix:
				v = db_prefix.get(value)
				v += values.get(value)
			else:
				v = values.get(value)
			db_prefix.update({value: v})
	return db_prefix


def create_dictionary_malware(db_train):
	"""All the features of all the malware families in the training set"""
	print('Loading Malware Dictionary - Start')
	db_train.pop("Safe", None)
	db_prefix = {}
	for family in db_train.keys():
		prefixes = db_train.get(family)
		for prefix in prefixes.keys():
			values = prefixes.get(prefix)
			for value in values:
				if value in db_prefix:
					v = db_prefix.get(value)
					v += values.get(value)
				else:
					v = values.get(value)
				db_prefix.update({value: v})
	db_prefix_n = filtering(db_prefix)
	print('Loading Malware Dictionary - End')
	return db_prefix_n


def create_dictionary_safe(db_train):
	"""All the features of all the safe family in the training set"""
	print('Loading Safe Dictionary - Start')
	db_prefix = {}
	prefixes = db_train.get('Safe')
	max_bar = len(prefixes.keys())
	incremento = 0
	for prefix in prefixes.keys():
		values = prefixes.get(prefix)
		for value in values:
			if value in db_prefix:
				v = db_prefix.get(value)
				v += values.get(value)
			else:
				v = values.get(value)
			db_prefix.update({value: v})
		incremento += 1
		progress_bar.update(max_bar, incremento)
	db_prefix_n = filtering(db_prefix)
	print('Loading Safe Dictionary - End')
	return db_prefix_n


def filtering(dic):
	"""Removes features with less then alpha occurences from the dictionary"""
	print('Normalizing Values - Start')
	alpha = 3  # minimum feature occurrece, default 3
	beta = 5  # minimum feature length, default 5
	max_bar = len(dic.keys())
	dic_n = dict(dic)
	incremento = 0
	for key in dic.keys():
		value = dic.get(key)
		if value < alpha or len(key) < beta:
			dic_n.pop(key, None)
		progress_bar.update(max_bar, incremento)
		incremento += 1
	print('Normalizing Values - End')
	return dic_n


def get_all_features(safe, malware):
	print('Loading all features - Start')
	features = list(safe.keys())
	in_first = set(features)
	in_second = set(malware.keys())
	in_second_but_not_in_first = in_second - in_first
	features += list(in_second_but_not_in_first)
	print('Loading all features - End')
	return features
