import os, sys
import re


def load_info():
	# with open('sha256_family.csv', 'r') as f:
	with open('test.csv', 'r') as f:
		raw_data = f.read()
		f.close()
	raw_data = raw_data.strip()
	data = raw_data.split('\n')
	hash_name = list()
	malware_name = list()
	for row in data:
		d = row.split(',')
		hash_name.append(d[0])
		malware_name.append(d[1])
	return hash_name[1:], malware_name[1:]
	# print(hash_name[100], malware_name[100])


def analyze_file(filename, family):
	with open('D:\\Users\\Gabriele\\Desktop\\Machine Learning\\Homework 1\\drebin\\feature_vectors\\'+filename, 'r') as f:
		raw_data = f.read()
		f.close()
	raw_data = raw_data.strip()
	data = raw_data.split('\n')
	dic = family
	for d in data:
		if d:
			d = d.strip()
			# print(d)
			infos = d.split('::')
			tipo = infos[0]
			valore = infos[1]
			if tipo in dic.keys():
				valori = dic.get(tipo)
				if valore in valori.keys():
					v = valori.get(valore)
					v += 1
					valori.update({valore: v})
				else:
					valori.update({valore: 1})
				dic.update({tipo: valori})
			else:
				dic.update({tipo: {valore: 1}})
	return dic


def database():
	hash_name, family = load_info()
	print(hash_name)
	print(family)
	db = {}
	for i, filename in enumerate(hash_name):
		fam = family[i]
		if fam in db.keys():
			dic = analyze_file(filename, db.get(fam))
		else:
			dic = analyze_file(filename, {})
		db.update({fam: dic})
	return db


def malware_converter():
	# mw = {}
	db = database()
	new_valori = {}
	for family in db.keys():
		print('FAMILY: ' + family)
		valori = db.get(family)
		for valore in valori.keys():
			attributo = valori.get(valore)
			for att in attributo.keys():
				a = attributo.get(att)
				# print(valore + ' ' + str(a))
				new_a = a
				new_attributo = new_valori.get(valore)
				if not new_attributo:
					new_attributo = {}
					new_valori.update({valore: {}})
				if att in new_attributo.keys():
					new_a += new_attributo.get(att)
				new_valori.get(valore).update({att: new_a})
				print('--> ' + valore + ':  ' + att + ' = ' + str(new_a))
	return new_valori


def folder_to_list():
	# Open a file
	path = 'D:\\Users\\Gabriele\\Desktop\\Machine Learning\\Homework 1\\drebin\\feature_vectors\\'
	dirs = os.listdir(path)
	return dirs


# def distributer(all_files, malware_files):
# 	safe_multi, malware_multi = dict(), dict()
# 	safe_ber, malware_ber = dict(), dict()
# 	n_safe, n_malware = 0, 0
# 	for i, filename in enumerate(all_files):
# 		if filename in malware_files:
# 			n_malware += 1
# 			for j in set(d[1:]):
# 				if j in malware_multi.keys():
# 					malware_multi[j] += 1
# 				else:
# 					malware_multi[j] = 1
# 				if j in malware_ber.keys():
# 					malware_ber[j] += 1
# 				else:
# 					malware_ber[j] = 1
# 				if not j in safe_multi.keys():
# 					safe_multi[j] = 0
# 				if not j in safe_ber.keys():
# 					safe_ber[j] = 0
# 	return safe_ber, safe_multi, malware_ber, malware_multi, n_safe, n_malware


if __name__ == "__main__":
	# db = database()
	# for i in db:
	# 	print(i)
	# 	print(db.get(i))
	#
	# print(database())
	# print(malware_converter())
	mw = malware_converter()
	for i in mw:
		print(i)
		print(mw.get(i))
	distributer(folder_to_list(), load_info()[0])
